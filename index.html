<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <link href='http://fonts.googleapis.com/css?family=Maven+Pro:400,500,700,900' rel='stylesheet' type='text/css'>
    <link href="third_party/syntaxhighlighter_3.0.83/styles/shCore.css" rel="stylesheet" type="text/css" />
    <link href="third_party/syntaxhighlighter_3.0.83/styles/shThemeRDark.css" rel="stylesheet" type="text/css" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

<link rel="shortcut icon" href="http://www.continuuity.com/wp-content/themes/continuuity/images/favicon.ico">

    <script type="text/javascript" src="third_party/syntaxhighlighter_3.0.83/scripts/shCore.js"></script>
    <script type="text/javascript" src="third_party/syntaxhighlighter_3.0.83/scripts/shBrushJScript.js"></script>
    <script type="text/javascript" src="third_party/syntaxhighlighter_3.0.83/scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="third_party/syntaxhighlighter_3.0.83/scripts/shBrushBash.js"></script>

    <title>Weave by Continuuity</title>

    </head>

  <body>
    <header>
      <div class="inner">
        <h1>Weave</h1>
        <h2>Running YARN apps as simply as running Java threads.</h2>
        <a href="https://github.com/continuuity/weave" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content" class="markdown-body entry-content" itemprop="mainContentOfPage">
        
         <h3><a name="weave-is-now-apache-twill-" class="anchor" href="#weave-is-now-apache-twill-"><span class="octicon octicon-link"></span></a>Weave is now Apache Twill</h3>

          <p>Weave has been accepted into the Apache Incubator under its new name: Twill. Development of Weave will be discontinued. Please go to <a href="http://twill.incubator.apache.org">Apache Twill</a> (twill.incubator.apache.org) for all future issues and requests.</p>

          <h3><a name="what-is-weave-" class="anchor" href="#what-is-weave-"><span class="octicon octicon-link"></span></a>What is Weave?</h3>

          <p>
          At <a href="http://www.continuuity.com/">Continuuity</a>, we use <a href="http://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/YARN.html">Apache YARN</a> as an integral part of our products because of its vision to support a diverse set of applications and processing patterns. One such product is BigFlow, our realtime distributed stream-processing engine. Apache YARN is used to run and manage BigFlow applications including lifecycle and runtime elasticity. During our journey with YARN we have come to the realization that it is extremely powerful but its full capability is challenging to leverage.  It is difficult to get started, hard to test and debug, and complex to build new kinds of non-MapReduce applications and frameworks on.
          </p>

          <p>Weave is a simple set of libraries that allows you to easily manage distributed applications through an abstraction layer built on Apache YARN. Weave allows you to use YARN’s distributed capabilities with a programming model that is similar to running threads. Weave is <strong>NOT</strong> a replacement for Apache YARN.  It is instead a value-added framework that operates on top of Apache YARN.</p>

          <h3><a name="why-do-i-need-weave-" class="anchor" href="#why-do-i-need-weave-"><span class="octicon octicon-link"></span></a>Why do I need Weave?</h3>

          <p>Weave dramatically simplifies and reduces your development efforts, enabling you to quickly and easily manage your distributed applications through its simplified abstraction layer built on YARN. YARN can be quite difficult to use and requires a large ramp up effort since it is built specifically for MapReduce and is typically meant for managing batch jobs. YARN, however, can be used as a generalized custom resource management tool that can run any type of job.  In additon to running batch jobs, cluster can be used for running real time jobs and long running job. Unfortunately, YARN’s capabilities are too low level to allow you to quickly develop an application, requiring a great deal of boilerplate code even for simple applications.  Additionally, its logging output is not available until the application is finished. This becomes a serious challenge when managing long running jobs: since those jobs never finish you cannot view the logs, which makes it very difficult to develop and debug such applications. Finally, YARN does not provide standard support for application lifecycle management, communication between containers and the Application Master, and handling application level errors.</p>

          <p>Continuuity Weave provides you with the following benefits:</p>

          <ul>
          <li>A simplified API for specifying, running and managing applications</li>
          <li>A simplified way to specify and manage the stages of the application lifecycle</li>
          <li>A generic Application Master to better support simple applications</li>
          <li>Log &amp; metrics aggregation for application</li>
          <li>Simplified archive management</li>
          <li>Improved control over application logs, metrics and errors</li>
          <li>Discovery service</li>
          </ul>


          <h3><a name="getting-started" class="anchor" href="#getting-started"><span class="octicon octicon-link"></span></a>Getting Started</h3>

          <h4>Building the Weave Library</h4>

          <pre class="brush: bash">$ git clone http://github.com/continuuity/weave.git
$ cd weave
$ mvn install</pre>

          <h3><a name="quick-example" class="anchor" href="#quick-example"><span class="octicon octicon-link"></span></a>Quick Example</h3>

          <p>Let's begin by building a basic <code>EchoServer</code> in Weave. Traditionally, when you build a server as simple
          as this, you add logic within a <code>Runnable</code> implementation to run it in within a <code>Thread</code> using an appropriate <code>ExecutorService</code>:</p>

          <pre class="brush: java">public class EchoServer implements Runnable {
  private static Logger LOG = LoggerFactory.getLogger(EchoServer.class);
  private final ServerSocket serverSocket;

  public EchoServer() {
    ...
  }

  @Override
  public void run() {
    while ( isRunning() ) {
      Socket socket = serverSocket.accept();
      ...
    }
  }
}</pre>

          <p>Our example defines an implementation of <code>Runnable</code> that implements the <code>run</code> method. The <code>EchoServer</code> is now a <code>Runnable</code> that can be
          executed by an <code>ExecutorService</code> in a <code>Thread</code>:</p>

          <pre class="brush: java">...
ExecutorService service = Executors.newFixedThreadPool(2);
service.submit(new EchoServer());
...</pre>

          <p>The above model is familiar, but now assume you want to run your EchoServer on a YARN cluster. To do this, all you need to do is implement the <code>WeaveRunnable</code> interface similarly to how you normally implement <code>Runnable</code>: </p>

          <h4>Implementing WeaveRunnable</h4>

          <pre class="brush: java">public class EchoServer implements WeaveRunnable {
  private static Logger LOG = LoggerFactory.getLogger(EchoServer.class);
  private final ServerSocket serverSocket;
  private final int port;

  public EchoServer() {
    ...
  }

  @Override
  public void run() {
    while ( isRunning() ) {
      Socket socket = serverSocket.accept();
      ...
    }
  }
}</pre>

          <p>The <code>EchoServer</code> implements <code>WeaveRunnable</code>, which implements <code>Runnable</code>. By doing this you can run a <code>WeaveRunnable</code> implementation within a <code>Thread</code> and also in a container on a YARN cluster. In order to run <code>EchoServer</code> on the YARN cluster, you must first create a <code>WeaveRunnerService</code>, which is similar to <code>ExecutorService</code>. To run on the YARN cluster, specify the YARN cluster configuration and connection string to a running instance of a Zookeeper service:</p>

          <h4>Starting the YARN Runner Service</h4>

          <pre class="brush: java">WeaveRunnerService runnerService = new YarnWeaveRunnerService(
  new YarnConfiguration(), zkConnectStr);
runnerService.startAndWait();</pre>

          <p>We have initialized <code>WeaveRunnerService</code>. We can now prepare to run the <code>EchoServer</code> on the YARN cluster, by attaching a log handler that ensures all logs generated by <code>EchoServer</code> across all nodes in the cluster are centralized on the client: </p>

          <h4>Preparing to Run WeaveRunnable</h4>

          <pre class="brush: java">WeaveController controller = runnerService.prepare(new EchoServer())
  .addLogHandler(new PrinterLogHandler(new PrintWriter(System.out)))
  .start();</pre>

          <p>Now that we have started, prepared, and launched <code>EchoServer</code> to run on the YARN cluster, we can attach listeners that allow you to observe state transitions in your application.</p>

          <h4>Attaching Listeners for State Transitions</h4>

          <pre class="brush: java">controller.addListener(new ListenerAdapter() {
  @Override
  public void running() {
    LOG.info('Echo Server Started');
  }
}</pre>

          <p>To stop the running <code>EchoServer</code>, use the controller returned during the start of the application:</p>

          <h4>Stopping WeaveRunnable</h4>

          <pre class="brush: java">controller.stop().get();</pre>

          <p>This will shut down the application master and all the configured containers. Note that you do not need to specify the archives
          that must be shipped to remote machines on the YARN cluster (where the container will run). This is all taken care by Weave.</p>

          <h2><a name="advanced-examples" class="anchor" href="#advanced-examples"><span class="octicon octicon-link"></span></a>Advanced Examples</h2>

          <h3><a name="discovery-service" class="anchor" href="#discovery-service"><span class="octicon octicon-link"></span></a>Discovery Service</h3>

          <p>The <code>EchoServer</code> is useful only if it's discoverable. Clients who want to access the server running in the cluster must be able to connect to the service and talk to it. Weave helps you accomplish this important purpose by exposing a discovery service that allows your running Weave application to announce itself on the cluster, making it possible for the client to discover and connect to it. Let's see how we can add this capability to the <code>EchoServer</code>. The <code>EchoServer</code> will start on a port available on the machine on which it started, and then announce its presence via the Weave discovery service API. In this example, the class extends <code>AbstractWeaveRunnable</code>, which in turn implements the <code>WeaveRunnable</code>, which implements <code>Runnable</code>:</p>

          <h4>WeaveRunnable with Discovery Announce</h4>

          <pre class="brush: java">public class EchoServer extends AbstractWeaveRunnable {
  private static final Logger LOG = LoggerFactory.getLogger(EchoServer.class);

  @Override
  public void initialize(WeaveContext context) {
    super.initialize(context);
    ...
    try {
      serverSocket = new ServerSocket(0); // start on any available port.
      context.announce("echo", serverSocket.getLocalPort());
    } catch (IOException e) {
      throw Throwables.propogate(e);
    }
  }

  @Override
  public void run() {
    ...
  }
}</pre>

          <p>During the initialization phase of the container, <code>WeaveContext</code> uses the port on which <code>EchoServer</code> was started to announce its presence. This enables clients to discover the <em>echo</em> service using a live iterator:</p>

          <h4>Client Discovery</h4>

          <pre class="brush: java">...
WeaveController controller = ....
...
Iterable echoServices = controller.discoverService("echo");
...
for(Discoverable discoverable : echoServices) {
  Socket socket = new Socket(discoverable.getSocketAddress().getAddress(),
                             discoverable.getSocketAddress().getPort());
  ...
}</pre>

          <h3><a name="logging" class="anchor" href="#logging"><span class="octicon octicon-link"></span></a>Logging</h3>

          <p>In the above examples a log handler was attached when preparing to run a implementation of <code>WeaveRunnable</code>. It is used for collecting all logs emitted by the containers. Logs are returned to the client to take an action. This way, when you debug the application you don't have to leave your IDE running on the YARN cluster. Within the container, you use a standard SLF4J logger to log messages. The logs are hijacked and sent through the Kafka broker to the client. With every application that is launched, a Kafka broker is started within the Application Master.</p>

          <h4>SLF4J logger for logging</h4>

          <pre class="brush: java">public class EchoServer extends AbstractWeaveRunnable {
  private static final Logger LOG = LoggerFactory.getLogger(EchoServer.class);
  ...
  @Override
  public void run() {
    ...
    LOG.info('New client accepted');
    ...
  }
  ...
}</pre>

          <h3><a name="resource-specification" class="anchor" href="#resource-specification"><span class="octicon octicon-link"></span></a>Resource Specification</h3>

          <p>While you prepare an implementation of <code>WeaveRunnable</code> to run on the YARN cluster, you must specify the resources used to run the container. Assets like the number of cores to be used, amount of memory, and number of instances can be specified. This internally uses Cgroups to limit the amount of system resources used by the container:</p>

          <h4>Specifying Resource Constraints for Container</h4>

          <pre class="brush: java">WeaveController controller = runnerService.prepare(new EchoServer(port),
  ResourceSpecification().Builder().with()
    .setCores(1)
    .setMemory(1, ResourceSpecification.SizeUnit.GIGA)
    .setInstances(2).build())
    .addLogHandler(new PrinterLogHandler(new PrintWriter(System.out)))
    .start();</pre>

          <h3><a name="archive-management" class="anchor" href="#archive-management"><span class="octicon octicon-link"></span></a>Archive Management</h3>

          <p>In order to run in a container on the YARN cluster, all the necessary jars must be marshalled to the node on which the container is running. This is all internally handled by Weave, but the APIs also allow you to specify additional files to be marshalled to the container where it's running.</p>

          <h3><a name="application" class="anchor" href="#application"><span class="octicon octicon-link"></span></a>Application</h3>

          <p>A <code>WeaveApplication</code> is a collection of distributed <code>WeaveRunnable</code> working together. For example, suppose you have a web application that you would like to deploy on a cluster running YARN. You will need instances of a jetty server and all associated files to serve the application:</p>

          <h4>Specifying WeaveApplication</h4>

          <pre class="brush: java">public class WebApplication implements WeaveApplication {
  @Override
  public WeaveSpecification configure() {
    return WeaveSpecification().Builder.with()
      .setName("My Web Application")
      .withRunnables()
         .add(new JettyWebServer())
         .withLocalFiles()
            .add("html-pages.tgz", pages, true)
         .apply()
         .add(new LogsCollector())
      .anyOrder()
      .build();
  }
}</pre>

          <p>Once you have defined an application in Weave, you can simply run it the same way you run <code>WeaveRunnable</code>. You might notice from the above example that Weave applications support the order in which the <code>WeaveRunnables</code> are started on the cluster. The example specifies no order, so all the <code>WeaveRunnables</code> can start concurrently. However, you can modify the behavior as follows:</p>

          <h4>Ordering</h4>

          <pre class="brush: java">public class WebApplication implements WeaveApplication {
  @Override
  public WeaveSpecification configure() {
    return WeaveSpecification().Builder.with()
      .setName("My Web Application")
      .withRunnables()
         .add("jetty", new JettyWebServer())
         .withLocalFiles()
            .add("html-pages.tgz", pages, true)
         .apply()
         .add("log", new LogsCollector())
      .order()
         .first("log")
         .next("jetty")
      .build();
  }
}</pre>

          <h2><a name="documentation--talks" class="anchor" href="#documentation--talks"><span class="octicon octicon-link"></span></a>Documentation &amp; Talks</h2>

          <h3><a name="api" class="anchor" href="#api"><span class="octicon octicon-link"></span></a>API</h3>

          <ul>
          <li><a href="http://continuuity.github.io/weave/apidocs/index.html" title="Weave Doc Index">Weave Doc Index</a></li>
          <li><a href="http://continuuity.github.io/weave/apidocs/com/continuuity/weave/api/package-summary.html" title="Weave API">Weave API</a></li>
          <li><a href="http://continuuity.github.io/weave/apidocs/com/continuuity/weave/yarn/package-summary.html" title="Weave YARN">Weave YARN</a></li>
          <li><a href="http://continuuity.github.io/weave/apidocs/com/continuuity/weave/common/package-summary.html" title="Weave Common">Weave Common</a></li>
          <li><a href="http://continuuity.github.io/weave/apidocs/com/continuuity/weave/discovery/package-summary.html" title="Weave Discovery">Weave Discovery</a></li>
          <li><a href="http://continuuity.github.io/weave/apidocs/com/continuuity/weave/zookeeper/package-summary.html" title="Weave Zookeeper">Weave Zookeeper</a></li>
          </ul>

          <h3><a name="talks" class="anchor" href="#talks"><span class="octicon octicon-link"></span></a>Talks</h3>

          <ul>
          <li><a href="http://continuuity.github.io/weave/talks/Weave-Talk-v1.0.pdf" title="Weave Introduction">Weave Introduction</a></li>
          </ul>

          <h2><a name="community" class="anchor" href="#community"><span class="octicon octicon-link"></span></a>Community</h2>

          <h3><a name="how-to-contribute" class="anchor" href="#how-to-contribute"><span class="octicon octicon-link"></span></a>How to Contribute</h3>

          <p>Are you interested in making Weave better? Our development model is a simple pull-based model with a consensus
          building phase, similar to the <a href="http://www.apache.org/foundation/voting.html" title="Apache Voting Process">Apache's voting process</a>. If you think that you help make Weave better, add new
          features or fix bugs in Weave or even if you have an idea on how to improve something that's already there in Weave, here's
          how you can do that: </p>

          <ul>
          <li>Fork <a href="https://github.com/continuuity/weave" title="weave">weave</a> into your own GitHub repository</li>
          <li>Create a topic branch with an appropriate name </li>
          <li>Work on your favourite feature to your content</li>
          <li>Once you are satisifed, create a pull request by going <a href="https://github.com/continuuity/weave" title="continuuity/weave">continuuity/weave</a> project. </li>
          <li>Address all the review comments</li>
          <li>Once addressed, the changes will be committed to the <a href="https://github.com/continuuity/weave" title="continuuity/weave">continuuity/weave</a> repo. </li>
          </ul>

          <h3><a name="groups" class="anchor" href="#groups"><span class="octicon octicon-link"></span></a>Groups</h3>

          <ul>
          <li>User Group: <a href="https://groups.google.com/d/forum/weave-user" title="weave-user">weave-user</a>
          </li>
          </ul>

          <h3><a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h3>

          <p>Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance
          with the License. You may obtain a copy of the License at</p>

          <p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>

          <p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed
          on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for
          the specific language governing permissions and limitations under the License.</p>

        </section>

        <aside id="sidebar">
          <a href="https://github.com/continuuity/weave/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/continuuity/weave/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/continuuity/weave"></a> is maintained by <a href="https://github.com/continuuity">continuuity</a>.</p>

          <p>This page was generated by <a href="pages.github.com">GitHub Pages</a> using the Architect theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

    <!-- Activate syntax highlighter.-->
    <script type="text/javascript">
      SyntaxHighlighter.defaults["gutter"] = false;
      SyntaxHighlighter.all()
    </script>

  </body>
</html>
